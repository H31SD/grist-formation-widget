<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Modules - Grist</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            padding: 10px;
        }
        .debug {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #fff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 10px;
            font-size: 11px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 9999;
        }
        .debug h4 {
            color: #667eea;
            margin-bottom: 5px;
        }
        .debug pre {
            background: #f8f9fa;
            padding: 5px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .status-ok { color: #28a745; }
        .status-error { color: #dc3545; }
        .status-warning { color: #ffc107; }
    </style>
</head>
<body>
    <div style="text-align: center; padding: 40px;">
        <h1 style="color: #667eea; margin-bottom: 20px;">üîß Widget Grist - Mode Debug</h1>
        <p>Cette version affiche des informations de diagnostic pour r√©soudre le probl√®me de sauvegarde.</p>
        
        <div style="margin-top: 30px; padding: 20px; background: white; border-radius: 12px; max-width: 600px; margin: 30px auto;">
            <h3>Test de connexion</h3>
            <button onclick="testConnection()" style="margin: 10px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                üîç Tester la connexion
            </button>
            <button onclick="testWrite()" style="margin: 10px; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
                ‚úèÔ∏è Tester l'√©criture
            </button>
            <button onclick="testRead()" style="margin: 10px; padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 6px; cursor: pointer;">
                üìñ Tester la lecture
            </button>
        </div>
    </div>
    
    <div id="debug" class="debug">
        <h4>üìä Console de Debug</h4>
        <pre id="debugLog">Initialisation...</pre>
    </div>

    <script>
        let debugLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            debugLog.push(entry);
            
            const logEl = document.getElementById('debugLog');
            const className = type === 'error' ? 'status-error' : type === 'ok' ? 'status-ok' : type === 'warning' ? 'status-warning' : '';
            logEl.innerHTML = debugLog.map(l => `<div class="${className}">${l}</div>`).join('');
            logEl.scrollTop = logEl.scrollHeight;
            
            console.log(entry);
        }
        
        let gristAPI = null;
        let tableAccess = null;
        
        async function init() {
            try {
                log('üöÄ Initialisation du widget...', 'info');
                
                // √âtape 1 : Connexion √† Grist
                log('üì° Connexion √† Grist API...', 'info');
                await grist.ready({
                    requiredAccess: 'full',
                    allowSelectBy: true
                });
                log('‚úÖ Connect√© √† Grist !', 'ok');
                
                // √âtape 2 : R√©cup√©rer l'acc√®s √† la table
                log('üìã R√©cup√©ration de l\'acc√®s √† la table...', 'info');
                gristAPI = grist.docApi;
                
                // R√©cup√©rer le nom de la table
                const tables = await gristAPI.listTables();
                log(`üìä Tables disponibles: ${JSON.stringify(tables)}`, 'info');
                
                // Utiliser directement la premi√®re table (FormationData)
                if (tables && tables.length > 0) {
                    const tableName = tables[0];
                    log(`üìã Utilisation de la table: ${tableName}`, 'info');
                    
                    // Cr√©er un objet d'acc√®s √† la table avec les bonnes m√©thodes
                    tableAccess = {
                        async getRecords() {
                            const data = await gristAPI.fetchTable(tableName);
                            return data;
                        },
                        async addRecords(records) {
                            return await gristAPI.applyUserActions([
                                ['AddRecord', tableName, null, records[0].fields]
                            ]);
                        },
                        async updateRecords(records) {
                            return await gristAPI.applyUserActions([
                                ['UpdateRecord', tableName, records[0].id, records[0].fields]
                            ]);
                        }
                    };
                    
                    log('‚úÖ Acc√®s √† la table cr√©√© !', 'ok');
                } else {
                    throw new Error('Aucune table trouv√©e');
                }
                
                log('üéâ Initialisation compl√®te !', 'ok');
                
            } catch (error) {
                log(`‚ùå ERREUR: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        }
        
        async function testConnection() {
            try {
                log('--- TEST DE CONNEXION ---', 'info');
                
                if (!gristAPI) {
                    log('‚ö†Ô∏è API Grist non initialis√©e', 'warning');
                    return;
                }
                
                // Tester l'acc√®s au document
                const docInfo = await gristAPI.getDocName();
                log(`‚úÖ Nom du document: ${docInfo}`, 'ok');
                
                // Lister les tables
                const tables = await gristAPI.listTables();
                log(`‚úÖ Tables: ${JSON.stringify(tables)}`, 'ok');
                
                log('‚úÖ Connexion fonctionnelle !', 'ok');
                
            } catch (error) {
                log(`‚ùå Erreur de connexion: ${error.message}`, 'error');
            }
        }
        
        async function testRead() {
            try {
                log('--- TEST DE LECTURE ---', 'info');
                
                if (!tableAccess) {
                    log('‚ö†Ô∏è Acc√®s table non disponible', 'warning');
                    return;
                }
                
                log('üìñ Lecture de la table...', 'info');
                const data = await gristAPI.fetchTable('FormationData');
                log(`‚úÖ Donn√©es re√ßues ! Colonnes: ${JSON.stringify(Object.keys(data))}`, 'ok');
                
                if (data.id && data.id.length > 0) {
                    log(`‚úÖ Nombre d'enregistrements: ${data.id.length}`, 'ok');
                    log(`üìÑ Premier ID: ${data.id[0]}`, 'info');
                    if (data.Dispositifs) {
                        log(`üìÑ Dispositifs: ${data.Dispositifs[0]}`, 'info');
                    }
                    if (data.Modules) {
                        log(`üìÑ Modules: ${data.Modules[0]}`, 'info');
                    }
                } else {
                    log('‚ö†Ô∏è Aucun enregistrement trouv√©', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Erreur de lecture: ${error.message}`, 'error');
            }
        }
        
        async function testWrite() {
            try {
                log('--- TEST D\'√âCRITURE ---', 'info');
                
                if (!gristAPI) {
                    log('‚ö†Ô∏è API Grist non disponible', 'warning');
                    return;
                }
                
                // Donn√©es de test
                const testData = {
                    dispositifs: [
                        {
                            id: 'test-' + Date.now(),
                            name: 'Test Dispositif',
                            objectif: 'Test d\'√©criture depuis le widget',
                            createdAt: new Date().toISOString()
                        }
                    ],
                    modules: []
                };
                
                log('üìù Tentative d\'√©criture...', 'info');
                
                // V√©rifier si une ligne existe d√©j√†
                const data = await gristAPI.fetchTable('FormationData');
                
                if (data.id && data.id.length > 0) {
                    // Mise √† jour
                    const recordId = data.id[0];
                    log(`üîÑ Mise √† jour de l'enregistrement ${recordId}...`, 'info');
                    
                    await gristAPI.applyUserActions([
                        ['UpdateRecord', 'FormationData', recordId, {
                            Dispositifs: JSON.stringify(testData.dispositifs),
                            Modules: JSON.stringify(testData.modules)
                        }]
                    ]);
                    
                    log('‚úÖ Enregistrement mis √† jour !', 'ok');
                    
                } else {
                    // Cr√©ation
                    log('‚ûï Cr√©ation d\'un nouvel enregistrement...', 'info');
                    
                    const result = await gristAPI.applyUserActions([
                        ['AddRecord', 'FormationData', null, {
                            Dispositifs: JSON.stringify(testData.dispositifs),
                            Modules: JSON.stringify(testData.modules)
                        }]
                    ]);
                    
                    log(`‚úÖ Enregistrement cr√©√© ! R√©sultat: ${JSON.stringify(result)}`, 'ok');
                }
                
                log('üéâ Test d\'√©criture r√©ussi !', 'ok');
                log('üëâ V√©rifiez maintenant votre table FormationData dans Grist', 'ok');
                
            } catch (error) {
                log(`‚ùå Erreur d'√©criture: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        }
        
        // Initialiser au chargement
        init();
    </script>
</body>
</html>
