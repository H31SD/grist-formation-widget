<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Modules de Formation - Grist Widget</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }
        
        .header h1 {
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 12px;
        }
        
        .toolbar {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: white;
            color: #495057;
            border: 1px solid #dee2e6;
        }
        
        .btn-secondary:hover {
            background: #f8f9fa;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .main-content {
            padding: 20px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        .module-actions {
            display: flex;
            gap: 5px;
        }
        
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: #6c757d;
            font-size: 14px;
            transition: color 0.2s;
        }
        
        .icon-btn:hover {
            color: #667eea;
        }
        
        .tree-view {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .tree-node {
            margin: 8px 0;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            transition: all 0.2s;
            cursor: move;
        }
        
        .tree-node:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .tree-node.dragging {
            opacity: 0.5;
        }
        
        .tree-node.drag-over {
            border: 2px dashed #667eea;
            background: #f8f9ff;
        }
        
        .tree-node.child {
            margin-left: 25px;
            border-left-color: #a78bfa;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 550px;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .modal-header h2 {
            color: #212529;
            font-size: 20px;
            margin-bottom: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #495057;
            font-weight: 500;
            font-size: 13px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            background: #e7f3ff;
            color: #0066cc;
        }
        
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 6px;
            z-index: 1;
            top: 100%;
            margin-top: 5px;
        }
        
        .dropdown-content button {
            width: 100%;
            padding: 10px 14px;
            text-align: left;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        
        .dropdown-content button:first-child {
            border-radius: 6px 6px 0 0;
        }
        
        .dropdown-content button:last-child {
            border-radius: 0 0 6px 6px;
        }
        
        .dropdown-content button:hover {
            background-color: #f8f9fa;
        }
        
        .dropdown.active .dropdown-content {
            display: block;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 11px;
            color: #6c757d;
            margin-top: 4px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Gestionnaire de Modules de Formation</h1>
            <p>Cr√©ez, organisez et g√©rez vos modules de formation - Int√©gr√© avec Grist</p>
        </div>
        
        <div class="toolbar">
            <button class="btn btn-primary" data-action="open-dispositif-modal">üìÅ Nouveau Dispositif</button>
            <button class="btn btn-primary" data-action="open-module-modal">‚ûï Nouveau Module</button>
            <input type="text" id="searchInput" placeholder="üîç Rechercher..." style="padding: 8px; border: 1px solid #ced4da; border-radius: 6px; width: 200px; font-size: 13px;">
            
            <div class="dropdown" id="exportDropdown">
                <button class="btn btn-secondary" data-action="toggle-export">üíæ Exporter ‚ñº</button>
                <div class="dropdown-content">
                    <button data-action="export-json">üíæ Format JSON</button>
                    <button data-action="export-excel">üìä Format Excel (CSV)</button>
                </div>
            </div>
            
            <button class="btn btn-secondary" data-action="sync-data">üîÑ Synchroniser</button>
        </div>

        <div class="main-content">
            <div id="loadingIndicator" class="loading" style="display: none;">
                <p>‚è≥ Chargement des donn√©es...</p>
            </div>
            
            <div id="mainView" style="display: none;">
                <div class="stats" id="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalModules">0</div>
                        <div class="stat-label">√âl√©ments totaux</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalEffectif">0</div>
                        <div class="stat-label">Effectif total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalDuree">0h</div>
                        <div class="stat-label">Dur√©e totale</div>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 15px; color: #495057; font-size: 16px;">Arborescence des dispositifs</h3>
                <div id="treeView" class="tree-view"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal pour cr√©er/√©diter un module -->
    <div class="modal" id="moduleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nouveau Module</h2>
            </div>
            
            <form id="moduleForm">
                <div class="form-group">
                    <label>Nom du module *</label>
                    <input type="text" id="moduleName" required placeholder="Ex: Formation initiale">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Effectif</label>
                        <input type="number" id="moduleEffectif" min="0" placeholder="Nombre de personnes">
                    </div>
                    
                    <div class="form-group">
                        <label>Dur√©e (heures)</label>
                        <input type="number" id="moduleDuree" min="0" step="0.5" placeholder="Ex: 6">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre de groupes</label>
                        <input type="number" id="moduleGroupes" min="0" placeholder="Ex: 3">
                    </div>
                    
                    <div class="form-group">
                        <label>D√©placements</label>
                        <input type="number" id="moduleDeplacements" min="0" placeholder="Ex: 1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Niveau de d√©placement</label>
                    <select id="moduleNiveauDeplacement">
                        <option value="">Non sp√©cifi√©</option>
                        <option value="national">National</option>
                        <option value="interacademique">Interacad√©mique</option>
                        <option value="academique">Acad√©mique</option>
                        <option value="departemental">D√©partemental</option>
                        <option value="reseau">R√©seau</option>
                        <option value="etablissement">√âtablissement</option>
                        <option value="distanciel">Distanciel</option>
                        <option value="invitation">Invitation</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Dispositif parent</label>
                    <select id="moduleParent">
                        <option value="">Aucun</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="moduleDescription" rows="2" placeholder="Description optionnelle"></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-action="close-module-modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal pour cr√©er/√©diter un dispositif -->
    <div class="modal" id="dispositifModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="dispositifModalTitle">Nouveau Dispositif</h2>
            </div>
            
            <form id="dispositifForm">
                <div class="form-group">
                    <label>Nom du dispositif *</label>
                    <input type="text" id="dispositifName" required placeholder="Ex: Formation Continue 2025">
                </div>
                
                <div class="form-group">
                    <label>Objectif de formation</label>
                    <textarea id="dispositifObjectif" rows="4" placeholder="D√©crivez les objectifs..."></textarea>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-action="close-dispositif-modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // GRIST WIDGET INTEGRATION
        // ============================================
        const GristApp = {
            state: {
                dispositifs: [],
                modules: [],
                currentEditingId: null,
                currentEditingDispositifId: null,
                draggedElement: null,
                searchTerm: '',
                gristReady: false,
                tableAccess: null
            },
            
            // ============================================
            // GRIST API METHODS
            // ============================================
            grist: {
                async init() {
                    try {
                        // Signal √† Grist que le widget est pr√™t et demande l'acc√®s complet
                        await grist.ready({
                            requiredAccess: 'full',
                            columns: [
                                {name: 'Dispositifs', type: 'Any', optional: true},
                                {name: 'Modules', type: 'Any', optional: true}
                            ]
                        });
                        
                        GristApp.state.gristReady = true;
                        console.log('‚úÖ Widget connect√© √† Grist');
                        
                        // Charger les donn√©es initiales
                        await GristApp.grist.loadFromGrist();
                        
                        // √âcouter les changements dans Grist
                        grist.onRecords(async (records) => {
                            console.log('üîÑ Donn√©es mises √† jour depuis Grist');
                            await GristApp.grist.loadFromGrist();
                        });
                        
                    } catch (error) {
                        console.error('‚ùå Erreur connexion Grist:', error);
                        // Mode fallback : utiliser localStorage
                        GristApp.data.loadFromLocalStorage();
                    }
                },
                
                async loadFromGrist() {
                    try {
                        document.getElementById('loadingIndicator').style.display = 'block';
                        document.getElementById('mainView').style.display = 'none';
                        
                        // R√©cup√©rer la table s√©lectionn√©e
                        const table = await grist.getTable();
                        const records = await table.getRecords();
                        
                        if (records && records.length > 0) {
                            // Chercher les colonnes Dispositifs et Modules
                            const record = records[0];
                            
                            if (record.Dispositifs) {
                                try {
                                    GristApp.state.dispositifs = JSON.parse(record.Dispositifs);
                                } catch (e) {
                                    GristApp.state.dispositifs = [];
                                }
                            }
                            
                            if (record.Modules) {
                                try {
                                    GristApp.state.modules = JSON.parse(record.Modules);
                                } catch (e) {
                                    GristApp.state.modules = [];
                                }
                            }
                        }
                        
                        GristApp.render.update();
                        
                        document.getElementById('loadingIndicator').style.display = 'none';
                        document.getElementById('mainView').style.display = 'block';
                        
                    } catch (error) {
                        console.error('‚ùå Erreur chargement depuis Grist:', error);
                        // Fallback vers localStorage
                        GristApp.data.loadFromLocalStorage();
                        document.getElementById('loadingIndicator').style.display = 'none';
                        document.getElementById('mainView').style.display = 'block';
                    }
                },
                
                async saveToGrist() {
                    if (!GristApp.state.gristReady) {
                        console.warn('‚ö†Ô∏è Grist non connect√©, sauvegarde locale');
                        GristApp.data.saveToLocalStorage();
                        return;
                    }
                    
                    try {
                        const table = await grist.getTable();
                        const records = await table.getRecords();
                        
                        const dispositifsJSON = JSON.stringify(GristApp.state.dispositifs);
                        const modulesJSON = JSON.stringify(GristApp.state.modules);
                        
                        if (records && records.length > 0) {
                            // Mise √† jour de l'enregistrement existant
                            const recordId = records[0].id;
                            await table.updateRecords([{
                                id: recordId,
                                fields: {
                                    Dispositifs: dispositifsJSON,
                                    Modules: modulesJSON
                                }
                            }]);
                        } else {
                            // Cr√©ation d'un nouvel enregistrement
                            await table.addRecords([{
                                fields: {
                                    Dispositifs: dispositifsJSON,
                                    Modules: modulesJSON
                                }
                            }]);
                        }
                        
                        console.log('‚úÖ Donn√©es sauvegard√©es dans Grist');
                        
                        // Sauvegarder aussi localement en backup
                        GristApp.data.saveToLocalStorage();
                        
                    } catch (error) {
                        console.error('‚ùå Erreur sauvegarde dans Grist:', error);
                        // Fallback vers localStorage
                        GristApp.data.saveToLocalStorage();
                    }
                }
            },
            
            // ============================================
            // GESTION DES DONN√âES (FALLBACK)
            // ============================================
            data: {
                loadFromLocalStorage() {
                    const savedDispositifs = localStorage.getItem('grist_formationDispositifs');
                    const savedModules = localStorage.getItem('grist_formationModules');
                    if (savedDispositifs) {
                        GristApp.state.dispositifs = JSON.parse(savedDispositifs);
                    }
                    if (savedModules) {
                        GristApp.state.modules = JSON.parse(savedModules);
                    }
                    GristApp.render.update();
                },
                
                saveToLocalStorage() {
                    localStorage.setItem('grist_formationDispositifs', JSON.stringify(GristApp.state.dispositifs));
                    localStorage.setItem('grist_formationModules', JSON.stringify(GristApp.state.modules));
                },
                
                getFilteredData() {
                    const term = GristApp.state.searchTerm.toLowerCase();
                    if (!term) {
                        return {
                            dispositifs: GristApp.state.dispositifs,
                            modules: GristApp.state.modules
                        };
                    }
                    
                    const filteredDispositifs = GristApp.state.dispositifs.filter(d => 
                        d.name.toLowerCase().includes(term) || 
                        (d.objectif && d.objectif.toLowerCase().includes(term))
                    );
                    
                    const filteredModules = GristApp.state.modules.filter(m => 
                        m.name.toLowerCase().includes(term) || 
                        (m.description && m.description.toLowerCase().includes(term)) ||
                        (m.niveauDeplacement && m.niveauDeplacement.toLowerCase().includes(term))
                    );
                    
                    return { dispositifs: filteredDispositifs, modules: filteredModules };
                }
            },
            
            // ============================================
            // UTILITAIRES
            // ============================================
            utils: {
                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                },
                
                debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                },
                
                downloadFile(content, filename, type) {
                    const blob = new Blob([content], { type });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.click();
                    URL.revokeObjectURL(url);
                }
            },
            
            // ============================================
            // RENDU DE L'INTERFACE
            // ============================================
            render: {
                stats() {
                    document.getElementById('totalModules').textContent = 
                        GristApp.state.dispositifs.length + GristApp.state.modules.length;
                    
                    const totalEffectif = GristApp.state.modules.reduce((sum, m) => sum + (m.effectif || 0), 0);
                    document.getElementById('totalEffectif').textContent = totalEffectif;
                    
                    const totalDuree = GristApp.state.modules.reduce((sum, m) => sum + (m.duree || 0), 0);
                    document.getElementById('totalDuree').textContent = totalDuree + 'h';
                },
                
                tree() {
                    const treeView = document.getElementById('treeView');
                    const { dispositifs, modules } = GristApp.data.getFilteredData();
                    
                    if (dispositifs.length === 0 && modules.length === 0) {
                        const isEmpty = GristApp.state.searchTerm 
                            ? `<p>Aucun r√©sultat pour "${GristApp.utils.escapeHtml(GristApp.state.searchTerm)}"</p>`
                            : `<p>Aucun √©l√©ment cr√©√©</p><p style="font-size: 11px; margin-top: 8px;">Cr√©ez d'abord un dispositif, puis ajoutez-y des modules</p>`;
                        
                        treeView.innerHTML = `<div class="empty-state">${isEmpty}</div>`;
                        return;
                    }
                    
                    const fragments = [];
                    
                    dispositifs.forEach(dispositif => {
                        const dispositifModules = modules.filter(m => m.parentId === dispositif.id);
                        
                        if (GristApp.state.searchTerm && dispositifModules.length === 0 && 
                            !dispositif.name.toLowerCase().includes(GristApp.state.searchTerm) && 
                            !(dispositif.objectif && dispositif.objectif.toLowerCase().includes(GristApp.state.searchTerm))) {
                            return;
                        }
                        
                        fragments.push(GristApp.render.dispositifNode(dispositif, dispositifModules));
                    });
                    
                    const orphanModules = modules.filter(m => !m.parentId);
                    if (orphanModules.length > 0) {
                        fragments.push(GristApp.render.orphanModulesSection(orphanModules));
                    }
                    
                    treeView.innerHTML = fragments.join('');
                },
                
                dispositifNode(dispositif, dispositifModules) {
                    const name = GristApp.utils.escapeHtml(dispositif.name);
                    const objectif = dispositif.objectif ? GristApp.utils.escapeHtml(dispositif.objectif) : '';
                    
                    return `
                        <div class="tree-node" 
                             draggable="false" 
                             data-type="dispositif" 
                             data-id="${dispositif.id}"
                             style="border-left-color: #667eea; background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <div style="font-weight: 700; color: #667eea; font-size: 15px;">üìÅ ${name}</div>
                                        <div class="module-actions">
                                            <button class="icon-btn" data-action="edit-dispositif" data-id="${dispositif.id}" title="Modifier">‚úèÔ∏è</button>
                                            <button class="icon-btn" data-action="delete-dispositif" data-id="${dispositif.id}" title="Supprimer">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    ${objectif ? `<div style="font-size: 12px; color: #6c757d; margin-bottom: 8px; font-style: italic;">${objectif}</div>` : ''}
                                    <div style="font-size: 11px; color: #667eea; font-weight: 600;">
                                        ${dispositifModules.length} module${dispositifModules.length > 1 ? 's' : ''}
                                    </div>
                                </div>
                            </div>
                            ${dispositifModules.map(m => GristApp.render.moduleNode(m)).join('')}
                        </div>
                    `;
                },
                
                moduleNode(module) {
                    const name = GristApp.utils.escapeHtml(module.name);
                    const niveau = module.niveauDeplacement ? `<div style="margin-top: 4px;"><span class="badge">${GristApp.utils.escapeHtml(module.niveauDeplacement)}</span></div>` : '';
                    
                    return `
                        <div class="tree-node child" 
                             draggable="true" 
                             data-type="module" 
                             data-id="${module.id}"
                             style="margin-top: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                        <div style="font-weight: 600; font-size: 14px;">üìö ${name}</div>
                                        <div class="module-actions">
                                            <button class="icon-btn" data-action="duplicate-module" data-id="${module.id}" title="Dupliquer">üìã</button>
                                            <button class="icon-btn" data-action="edit-module" data-id="${module.id}" title="Modifier">‚úèÔ∏è</button>
                                            <button class="icon-btn" data-action="delete-module" data-id="${module.id}" title="Supprimer">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    <div style="font-size: 11px; color: #6c757d; margin-bottom: 4px;">
                                        üë• ${module.effectif} pers. ‚Ä¢ ‚è±Ô∏è ${module.duree}h ‚Ä¢ üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ${module.groupes} groupes ‚Ä¢ üöó ${module.deplacements} d√©pl.
                                    </div>
                                    ${niveau}
                                </div>
                            </div>
                        </div>
                    `;
                },
                
                orphanModulesSection(orphanModules) {
                    return `
                        <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; border-left: 3px solid #ffc107;">
                            <div style="font-weight: 600; color: #856404; margin-bottom: 8px; font-size: 13px;">‚ö†Ô∏è Modules sans dispositif</div>
                            ${orphanModules.map(m => {
                                const name = GristApp.utils.escapeHtml(m.name);
                                const niveau = m.niveauDeplacement ? `<div style="margin-top: 4px;"><span class="badge">${GristApp.utils.escapeHtml(m.niveauDeplacement)}</span></div>` : '';
                                
                                return `
                                    <div class="tree-node" 
                                         draggable="true"
                                         data-type="module" 
                                         data-id="${m.id}"
                                         style="margin: 6px 0; border-left-color: #ffc107;">
                                        <div style="display: flex; justify-content: space-between; align-items: start;">
                                            <div style="flex: 1;">
                                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                    <div style="font-weight: 600; font-size: 13px;">üìö ${name}</div>
                                                    <div class="module-actions">
                                                        <button class="icon-btn" data-action="duplicate-module" data-id="${m.id}" title="Dupliquer">üìã</button>
                                                        <button class="icon-btn" data-action="edit-module" data-id="${m.id}" title="Modifier">‚úèÔ∏è</button>
                                                        <button class="icon-btn" data-action="delete-module" data-id="${m.id}" title="Supprimer">üóëÔ∏è</button>
                                                    </div>
                                                </div>
                                                <div style="font-size: 11px; color: #6c757d;">
                                                    üë• ${m.effectif} pers. ‚Ä¢ ‚è±Ô∏è ${m.duree}h ‚Ä¢ üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ${m.groupes} groupes ‚Ä¢ üöó ${m.deplacements} d√©pl.
                                                </div>
                                                ${niveau}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                },
                
                update() {
                    GristApp.render.tree();
                    GristApp.render.stats();
                }
            },
            
            // ============================================
            // ACTIONS
            // ============================================
            actions: {
                openDispositifModal(dispositifId = null) {
                    const modal = document.getElementById('dispositifModal');
                    const form = document.getElementById('dispositifForm');
                    const title = document.getElementById('dispositifModalTitle');
                    
                    form.reset();
                    GristApp.state.currentEditingDispositifId = dispositifId;
                    
                    if (dispositifId) {
                        title.textContent = 'Modifier le dispositif';
                        const dispositif = GristApp.state.dispositifs.find(d => d.id === dispositifId);
                        if (dispositif) {
                            document.getElementById('dispositifName').value = dispositif.name;
                            document.getElementById('dispositifObjectif').value = dispositif.objectif || '';
                        }
                    } else {
                        title.textContent = 'Nouveau Dispositif';
                    }
                    
                    modal.classList.add('active');
                },
                
                closeDispositifModal() {
                    document.getElementById('dispositifModal').classList.remove('active');
                    GristApp.state.currentEditingDispositifId = null;
                },
                
                async saveDispositif(e) {
                    e.preventDefault();
                    
                    const dispositifData = {
                        id: GristApp.state.currentEditingDispositifId || 'disp-' + Date.now().toString(),
                        name: document.getElementById('dispositifName').value,
                        objectif: document.getElementById('dispositifObjectif').value,
                        type: 'dispositif',
                        createdAt: GristApp.state.currentEditingDispositifId 
                            ? GristApp.state.dispositifs.find(d => d.id === GristApp.state.currentEditingDispositifId).createdAt 
                            : new Date().toISOString()
                    };
                    
                    if (GristApp.state.currentEditingDispositifId) {
                        const index = GristApp.state.dispositifs.findIndex(d => d.id === GristApp.state.currentEditingDispositifId);
                        GristApp.state.dispositifs[index] = dispositifData;
                    } else {
                        GristApp.state.dispositifs.push(dispositifData);
                    }
                    
                    await GristApp.grist.saveToGrist();
                    GristApp.render.update();
                    GristApp.actions.closeDispositifModal();
                },
                
                async deleteDispositif(id) {
                    if (confirm('√ätes-vous s√ªr de vouloir supprimer ce dispositif et tous ses modules ?')) {
                        GristApp.state.modules = GristApp.state.modules.filter(m => m.parentId !== id);
                        GristApp.state.dispositifs = GristApp.state.dispositifs.filter(d => d.id !== id);
                        await GristApp.grist.saveToGrist();
                        GristApp.render.update();
                    }
                },
                
                openModuleModal(moduleId = null) {
                    const modal = document.getElementById('moduleModal');
                    const form = document.getElementById('moduleForm');
                    const title = document.getElementById('modalTitle');
                    
                    form.reset();
                    GristApp.state.currentEditingId = moduleId;
                    
                    const parentSelect = document.getElementById('moduleParent');
                    parentSelect.innerHTML = '<option value="">Aucun</option>';
                    GristApp.state.dispositifs.forEach(d => {
                        parentSelect.innerHTML += `<option value="${d.id}">${GristApp.utils.escapeHtml(d.name)}</option>`;
                    });
                    
                    if (moduleId) {
                        title.textContent = 'Modifier le module';
                        const module = GristApp.state.modules.find(m => m.id === moduleId);
                        if (module) {
                            document.getElementById('moduleName').value = module.name;
                            document.getElementById('moduleEffectif').value = module.effectif || '';
                            document.getElementById('moduleDuree').value = module.duree || '';
                            document.getElementById('moduleGroupes').value = module.groupes || '';
                            document.getElementById('moduleDeplacements').value = module.deplacements || '';
                            document.getElementById('moduleNiveauDeplacement').value = module.niveauDeplacement || '';
                            document.getElementById('moduleParent').value = module.parentId || '';
                            document.getElementById('moduleDescription').value = module.description || '';
                        }
                    } else {
                        title.textContent = 'Nouveau Module';
                    }
                    
                    modal.classList.add('active');
                },
                
                closeModuleModal() {
                    document.getElementById('moduleModal').classList.remove('active');
                    GristApp.state.currentEditingId = null;
                },
                
                async saveModule(e) {
                    e.preventDefault();
                    
                    const moduleData = {
                        id: GristApp.state.currentEditingId || 'mod-' + Date.now().toString(),
                        name: document.getElementById('moduleName').value,
                        type: 'module',
                        effectif: parseInt(document.getElementById('moduleEffectif').value) || 0,
                        duree: parseFloat(document.getElementById('moduleDuree').value) || 0,
                        groupes: parseInt(document.getElementById('moduleGroupes').value) || 0,
                        deplacements: parseInt(document.getElementById('moduleDeplacements').value) || 0,
                        niveauDeplacement: document.getElementById('moduleNiveauDeplacement').value || '',
                        parentId: document.getElementById('moduleParent').value || null,
                        description: document.getElementById('moduleDescription').value,
                        createdAt: GristApp.state.currentEditingId 
                            ? GristApp.state.modules.find(m => m.id === GristApp.state.currentEditingId).createdAt 
                            : new Date().toISOString()
                    };
                    
                    if (GristApp.state.currentEditingId) {
                        const index = GristApp.state.modules.findIndex(m => m.id === GristApp.state.currentEditingId);
                        GristApp.state.modules[index] = moduleData;
                    } else {
                        GristApp.state.modules.push(moduleData);
                    }
                    
                    await GristApp.grist.saveToGrist();
                    GristApp.render.update();
                    GristApp.actions.closeModuleModal();
                },
                
                async deleteModule(id) {
                    if (confirm('√ätes-vous s√ªr de vouloir supprimer ce module ?')) {
                        GristApp.state.modules = GristApp.state.modules.filter(m => m.id !== id);
                        await GristApp.grist.saveToGrist();
                        GristApp.render.update();
                    }
                },
                
                async duplicateModule(id) {
                    const module = GristApp.state.modules.find(m => m.id === id);
                    if (module) {
                        const newModule = {
                            ...module,
                            id: 'mod-' + Date.now().toString(),
                            name: module.name + ' (copie)',
                            createdAt: new Date().toISOString()
                        };
                        GristApp.state.modules.push(newModule);
                        await GristApp.grist.saveToGrist();
                        GristApp.render.update();
                    }
                },
                
                exportJSON() {
                    const data = {
                        dispositifs: GristApp.state.dispositifs,
                        modules: GristApp.state.modules,
                        exportDate: new Date().toISOString()
                    };
                    const content = JSON.stringify(data, null, 2);
                    const filename = `formation-data-${new Date().toISOString().split('T')[0]}.json`;
                    GristApp.utils.downloadFile(content, filename, 'application/json');
                    GristApp.actions.closeExportMenu();
                },
                
                exportExcel() {
                    let csv = 'Type,Nom,Dispositif Parent,Objectif,Effectif,Dur√©e (h),Groupes,D√©placements,Niveau d√©placement,Description\n';
                    
                    GristApp.state.dispositifs.forEach(d => {
                        csv += `"Dispositif","${d.name}","","${d.objectif || ''}","","","","","",""\n`;
                    });
                    
                    GristApp.state.modules.forEach(m => {
                        const parent = GristApp.state.dispositifs.find(d => d.id === m.parentId);
                        csv += `"Module","${m.name}","${parent ? parent.name : ''}","","${m.effectif}","${m.duree}","${m.groupes}","${m.deplacements}","${m.niveauDeplacement || ''}","${m.description || ''}"\n`;
                    });
                    
                    const content = '\uFEFF' + csv;
                    const filename = `formation-data-${new Date().toISOString().split('T')[0]}.csv`;
                    GristApp.utils.downloadFile(content, filename, 'text/csv;charset=utf-8;');
                    GristApp.actions.closeExportMenu();
                },
                
                async syncData() {
                    document.getElementById('loadingIndicator').style.display = 'block';
                    document.getElementById('mainView').style.display = 'none';
                    await GristApp.grist.loadFromGrist();
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('mainView').style.display = 'block';
                },
                
                toggleExportMenu(e) {
                    e.stopPropagation();
                    document.getElementById('exportDropdown').classList.toggle('active');
                },
                
                closeExportMenu() {
                    document.getElementById('exportDropdown').classList.remove('active');
                }
            },
            
            // ============================================
            // DRAG & DROP
            // ============================================
            dragDrop: {
                init() {
                    const treeView = document.getElementById('treeView');
                    
                    treeView.addEventListener('dragstart', (e) => {
                        const element = e.target.closest('[data-type]');
                        if (!element) return;
                        
                        GristApp.state.draggedElement = {
                            type: element.dataset.type,
                            id: element.dataset.id
                        };
                        element.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                    });
                    
                    treeView.addEventListener('dragover', (e) => {
                        if (!GristApp.state.draggedElement) return;
                        
                        e.preventDefault();
                        const target = e.target.closest('[data-type]');
                        if (!target) return;
                        
                        if (GristApp.state.draggedElement.type === 'module') {
                            const targetType = target.dataset.type;
                            const targetId = target.dataset.id;
                            
                            if (targetId === GristApp.state.draggedElement.id) return;
                            
                            if (targetType === 'dispositif' || targetType === 'module') {
                                target.classList.add('drag-over');
                                e.dataTransfer.dropEffect = 'move';
                            }
                        }
                    });
                    
                    treeView.addEventListener('dragleave', (e) => {
                        const target = e.target.closest('[data-type]');
                        if (target) {
                            target.classList.remove('drag-over');
                        }
                    });
                    
                    treeView.addEventListener('drop', async (e) => {
                        e.preventDefault();
                        
                        const target = e.target.closest('[data-type]');
                        if (!target || !GristApp.state.draggedElement || GristApp.state.draggedElement.type !== 'module') {
                            return;
                        }
                        
                        const targetType = target.dataset.type;
                        const targetId = target.dataset.id;
                        
                        if (targetId === GristApp.state.draggedElement.id) {
                            target.classList.remove('drag-over');
                            return;
                        }
                        
                        const draggedModule = GristApp.state.modules.find(m => m.id === GristApp.state.draggedElement.id);
                        
                        if (targetType === 'dispositif' && draggedModule) {
                            draggedModule.parentId = targetId;
                            await GristApp.grist.saveToGrist();
                            GristApp.render.update();
                        } else if (targetType === 'module' && draggedModule) {
                            const targetModule = GristApp.state.modules.find(m => m.id === targetId);
                            if (targetModule) {
                                draggedModule.parentId = targetModule.parentId;
                                await GristApp.grist.saveToGrist();
                                GristApp.render.update();
                            }
                        }
                        
                        document.querySelectorAll('.drag-over').forEach(el => {
                            el.classList.remove('drag-over');
                        });
                    });
                    
                    treeView.addEventListener('dragend', (e) => {
                        const element = e.target.closest('[data-type]');
                        if (element) {
                            element.classList.remove('dragging');
                        }
                        document.querySelectorAll('.drag-over').forEach(el => {
                            el.classList.remove('drag-over');
                        });
                        GristApp.state.draggedElement = null;
                    });
                }
            },
            
            // ============================================
            // INITIALISATION
            // ============================================
            async init() {
                // Afficher le loader
                document.getElementById('loadingIndicator').style.display = 'block';
                
                // Initialiser la connexion Grist
                await GristApp.grist.init();
                
                // D√©l√©gation d'√©v√©nements
                document.addEventListener('click', (e) => {
                    const action = e.target.closest('[data-action]');
                    if (!action) return;
                    
                    const actionType = action.dataset.action;
                    const id = action.dataset.id;
                    
                    switch(actionType) {
                        case 'open-dispositif-modal':
                            GristApp.actions.openDispositifModal();
                            break;
                        case 'open-module-modal':
                            GristApp.actions.openModuleModal();
                            break;
                        case 'close-dispositif-modal':
                            GristApp.actions.closeDispositifModal();
                            break;
                        case 'close-module-modal':
                            GristApp.actions.closeModuleModal();
                            break;
                        case 'edit-dispositif':
                            e.stopPropagation();
                            GristApp.actions.openDispositifModal(id);
                            break;
                        case 'delete-dispositif':
                            e.stopPropagation();
                            GristApp.actions.deleteDispositif(id);
                            break;
                        case 'edit-module':
                            e.stopPropagation();
                            GristApp.actions.openModuleModal(id);
                            break;
                        case 'delete-module':
                            e.stopPropagation();
                            GristApp.actions.deleteModule(id);
                            break;
                        case 'duplicate-module':
                            e.stopPropagation();
                            GristApp.actions.duplicateModule(id);
                            break;
                        case 'toggle-export':
                            GristApp.actions.toggleExportMenu(e);
                            break;
                        case 'export-json':
                            GristApp.actions.exportJSON();
                            break;
                        case 'export-excel':
                            GristApp.actions.exportExcel();
                            break;
                        case 'sync-data':
                            GristApp.actions.syncData();
                            break;
                    }
                });
                
                // Fermer dropdown si clic ailleurs
                document.addEventListener('click', (e) => {
                    const dropdown = document.getElementById('exportDropdown');
                    if (!dropdown.contains(e.target)) {
                        dropdown.classList.remove('active');
                    }
                });
                
                // Fermer modals si clic sur backdrop
                document.getElementById('moduleModal').addEventListener('click', (e) => {
                    if (e.target.id === 'moduleModal') {
                        GristApp.actions.closeModuleModal();
                    }
                });
                
                document.getElementById('dispositifModal').addEventListener('click', (e) => {
                    if (e.target.id === 'dispositifModal') {
                        GristApp.actions.closeDispositifModal();
                    }
                });
                
                // Recherche avec debouncing
                const debouncedSearch = GristApp.utils.debounce(() => {
                    GristApp.state.searchTerm = document.getElementById('searchInput').value.toLowerCase();
                    GristApp.render.tree();
                }, 300);
                
                document.getElementById('searchInput').addEventListener('input', debouncedSearch);
                
                // Formulaires
                document.getElementById('dispositifForm').addEventListener('submit', GristApp.actions.saveDispositif);
                document.getElementById('moduleForm').addEventListener('submit', GristApp.actions.saveModule);
                
                // Drag & drop
                GristApp.dragDrop.init();
            }
        };
        
        // D√©marrer l'application
        GristApp.init();
    </script>
</body>
</html>
