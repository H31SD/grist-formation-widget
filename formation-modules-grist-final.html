<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Modules de Formation - Grist</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            padding: 5px;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
        }
        .header h1 { font-size: 20px; margin-bottom: 3px; }
        .header p { opacity: 0.9; font-size: 11px; }
        .toolbar {
            padding: 12px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
        }
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-secondary { background: white; color: #495057; border: 1px solid #dee2e6; }
        .btn-secondary:hover { background: #f8f9fa; }
        .main-content { padding: 15px; max-height: calc(100vh - 200px); overflow-y: auto; }
        .module-actions { display: flex; gap: 4px; }
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #6c757d;
            font-size: 13px;
            transition: color 0.2s;
        }
        .icon-btn:hover { color: #667eea; }
        .tree-view { padding: 12px; background: #f8f9fa; border-radius: 6px; }
        .tree-node {
            margin: 6px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #667eea;
            transition: all 0.2s;
            cursor: move;
        }
        .tree-node:hover { box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .tree-node.dragging { opacity: 0.5; }
        .tree-node.drag-over { border: 2px dashed #667eea; background: #f8f9ff; }
        .tree-node.child { margin-left: 20px; border-left-color: #a78bfa; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header h2 { color: #212529; font-size: 18px; margin-bottom: 12px; }
        .form-group { margin-bottom: 12px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
            font-size: 12px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 7px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 12px;
            font-family: inherit;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid #e9ecef;
        }
        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
            background: #e7f3ff;
            color: #0066cc;
        }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 5px;
            z-index: 1;
            top: 100%;
            margin-top: 4px;
        }
        .dropdown-content button {
            width: 100%;
            padding: 8px 12px;
            text-align: left;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        .dropdown-content button:first-child { border-radius: 5px 5px 0 0; }
        .dropdown-content button:last-child { border-radius: 0 0 5px 5px; }
        .dropdown-content button:hover { background-color: #f8f9fa; }
        .dropdown.active .dropdown-content { display: block; }
        .empty-state { text-align: center; padding: 30px 15px; color: #6c757d; font-size: 13px; }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 12px;
        }
        .stat-card { background: #f8f9fa; padding: 10px; border-radius: 6px; text-align: center; }
        .stat-value { font-size: 18px; font-weight: 700; color: #667eea; }
        .stat-label { font-size: 10px; color: #6c757d; margin-top: 3px; }
        .loading { text-align: center; padding: 30px; color: #6c757d; font-size: 13px; }
        .sync-status {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 11px;
            z-index: 999;
            display: none;
        }
        .sync-status.show { display: block; }
        .sync-status.success { color: #28a745; border-left: 3px solid #28a745; }
        .sync-status.error { color: #dc3545; border-left: 3px solid #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Gestionnaire de Modules de Formation</h1>
            <p>G√©rez vos dispositifs et modules - Synchronis√© avec Grist</p>
        </div>
        
        <div class="toolbar">
            <button class="btn btn-primary" data-action="open-dispositif-modal">üìÅ Dispositif</button>
            <button class="btn btn-primary" data-action="open-module-modal">‚ûï Module</button>
            <input type="text" id="searchInput" placeholder="üîç Rechercher..." style="padding: 6px; border: 1px solid #ced4da; border-radius: 5px; width: 180px; font-size: 12px;">
            
            <div class="dropdown" id="exportDropdown">
                <button class="btn btn-secondary" data-action="toggle-export">üíæ Exporter ‚ñº</button>
                <div class="dropdown-content">
                    <button data-action="export-json">üíæ JSON</button>
                    <button data-action="export-excel">üìä CSV</button>
                </div>
            </div>
            
            <button class="btn btn-secondary" data-action="sync-data">üîÑ Sync</button>
        </div>

        <div class="main-content">
            <div id="loadingIndicator" class="loading">‚è≥ Chargement...</div>
            
            <div id="mainView" style="display: none;">
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalModules">0</div>
                        <div class="stat-label">√âl√©ments</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalEffectif">0</div>
                        <div class="stat-label">Effectif</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalDuree">0h</div>
                        <div class="stat-label">Dur√©e</div>
                    </div>
                </div>
                
                <h3 style="margin-bottom: 12px; color: #495057; font-size: 14px;">Arborescence</h3>
                <div id="treeView" class="tree-view"></div>
            </div>
        </div>
    </div>
    
    <div class="sync-status" id="syncStatus"></div>
    
    <!-- Modal Module -->
    <div class="modal" id="moduleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nouveau Module</h2>
            </div>
            <form id="moduleForm">
                <div class="form-group">
                    <label>Nom du module *</label>
                    <input type="text" id="moduleName" required placeholder="Ex: Formation initiale">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Effectif</label>
                        <input type="number" id="moduleEffectif" min="0" placeholder="Personnes">
                    </div>
                    <div class="form-group">
                        <label>Dur√©e (h)</label>
                        <input type="number" id="moduleDuree" min="0" step="0.5" placeholder="Ex: 6">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Groupes</label>
                        <input type="number" id="moduleGroupes" min="0" placeholder="Ex: 3">
                    </div>
                    <div class="form-group">
                        <label>D√©placements</label>
                        <input type="number" id="moduleDeplacements" min="0" placeholder="Ex: 1">
                    </div>
                </div>
                <div class="form-group">
                    <label>Niveau d√©placement</label>
                    <select id="moduleNiveauDeplacement">
                        <option value="">Non sp√©cifi√©</option>
                        <option value="national">National</option>
                        <option value="interacademique">Interacad√©mique</option>
                        <option value="academique">Acad√©mique</option>
                        <option value="departemental">D√©partemental</option>
                        <option value="reseau">R√©seau</option>
                        <option value="etablissement">√âtablissement</option>
                        <option value="distanciel">Distanciel</option>
                        <option value="invitation">Invitation</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Dispositif parent</label>
                    <select id="moduleParent">
                        <option value="">Aucun</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="moduleDescription" rows="2" placeholder="Optionnel"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-action="close-module-modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal Dispositif -->
    <div class="modal" id="dispositifModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="dispositifModalTitle">Nouveau Dispositif</h2>
            </div>
            <form id="dispositifForm">
                <div class="form-group">
                    <label>Nom du dispositif *</label>
                    <input type="text" id="dispositifName" required placeholder="Ex: Formation 2025">
                </div>
                <div class="form-group">
                    <label>Objectif de formation</label>
                    <textarea id="dispositifObjectif" rows="3" placeholder="Objectifs..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-action="close-dispositif-modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const App = {
            state: {
                dispositifs: [],
                modules: [],
                currentEditingId: null,
                currentEditingDispositifId: null,
                draggedElement: null,
                searchTerm: '',
                gristAPI: null,
                isReady: false
            },
            
            utils: {
                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                },
                debounce(func, wait) {
                    let timeout;
                    return function(...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func(...args), wait);
                    };
                },
                downloadFile(content, filename, type) {
                    const blob = new Blob([content], { type });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.click();
                    URL.revokeObjectURL(url);
                },
                showSyncStatus(message, type = 'success') {
                    const status = document.getElementById('syncStatus');
                    status.textContent = message;
                    status.className = `sync-status show ${type}`;
                    setTimeout(() => status.classList.remove('show'), 2000);
                }
            },
            
            grist: {
                async init() {
                    try {
                        await grist.ready({ requiredAccess: 'full' });
                        App.state.gristAPI = grist.docApi;
                        App.state.isReady = true;
                        console.log('‚úÖ Grist connect√©');
                        await App.grist.load();
                        
                        // √âcouter les changements
                        grist.onRecords(() => App.grist.load());
                    } catch (error) {
                        console.error('‚ùå Erreur Grist:', error);
                        App.utils.showSyncStatus('Erreur de connexion', 'error');
                    }
                },
                
                async load() {
                    try {
                        document.getElementById('loadingIndicator').style.display = 'block';
                        document.getElementById('mainView').style.display = 'none';
                        
                        const data = await App.state.gristAPI.fetchTable('FormationData');
                        
                        if (data.id && data.id.length > 0) {
                            if (data.Dispositifs && data.Dispositifs[0]) {
                                try {
                                    App.state.dispositifs = JSON.parse(data.Dispositifs[0]);
                                } catch(e) {
                                    App.state.dispositifs = [];
                                }
                            }
                            if (data.Modules && data.Modules[0]) {
                                try {
                                    App.state.modules = JSON.parse(data.Modules[0]);
                                } catch(e) {
                                    App.state.modules = [];
                                }
                            }
                        }
                        
                        App.render.update();
                        document.getElementById('loadingIndicator').style.display = 'none';
                        document.getElementById('mainView').style.display = 'block';
                    } catch (error) {
                        console.error('‚ùå Erreur load:', error);
                        App.utils.showSyncStatus('Erreur chargement', 'error');
                    }
                },
                
                async save() {
                    if (!App.state.isReady) return;
                    
                    try {
                        const data = await App.state.gristAPI.fetchTable('FormationData');
                        const dispositifsJSON = JSON.stringify(App.state.dispositifs);
                        const modulesJSON = JSON.stringify(App.state.modules);
                        
                        if (data.id && data.id.length > 0) {
                            await App.state.gristAPI.applyUserActions([
                                ['UpdateRecord', 'FormationData', data.id[0], {
                                    Dispositifs: dispositifsJSON,
                                    Modules: modulesJSON
                                }]
                            ]);
                        } else {
                            await App.state.gristAPI.applyUserActions([
                                ['AddRecord', 'FormationData', null, {
                                    Dispositifs: dispositifsJSON,
                                    Modules: modulesJSON
                                }]
                            ]);
                        }
                        
                        App.utils.showSyncStatus('‚úì Sauvegard√©', 'success');
                    } catch (error) {
                        console.error('‚ùå Erreur save:', error);
                        App.utils.showSyncStatus('Erreur sauvegarde', 'error');
                    }
                }
            },
            
            data: {
                getFilteredData() {
                    const term = App.state.searchTerm.toLowerCase();
                    if (!term) {
                        return {
                            dispositifs: App.state.dispositifs,
                            modules: App.state.modules
                        };
                    }
                    
                    return {
                        dispositifs: App.state.dispositifs.filter(d => 
                            d.name.toLowerCase().includes(term) || 
                            (d.objectif && d.objectif.toLowerCase().includes(term))
                        ),
                        modules: App.state.modules.filter(m => 
                            m.name.toLowerCase().includes(term) || 
                            (m.description && m.description.toLowerCase().includes(term)) ||
                            (m.niveauDeplacement && m.niveauDeplacement.toLowerCase().includes(term))
                        )
                    };
                }
            },
            
            render: {
                stats() {
                    document.getElementById('totalModules').textContent = 
                        App.state.dispositifs.length + App.state.modules.length;
                    document.getElementById('totalEffectif').textContent = 
                        App.state.modules.reduce((sum, m) => sum + (m.effectif || 0), 0);
                    document.getElementById('totalDuree').textContent = 
                        App.state.modules.reduce((sum, m) => sum + (m.duree || 0), 0) + 'h';
                },
                
                tree() {
                    const treeView = document.getElementById('treeView');
                    const { dispositifs, modules } = App.data.getFilteredData();
                    
                    if (dispositifs.length === 0 && modules.length === 0) {
                        const msg = App.state.searchTerm 
                            ? `Aucun r√©sultat pour "${App.utils.escapeHtml(App.state.searchTerm)}"`
                            : 'Aucun √©l√©ment. Cr√©ez un dispositif pour commencer.';
                        treeView.innerHTML = `<div class="empty-state">${msg}</div>`;
                        return;
                    }
                    
                    const html = [];
                    
                    dispositifs.forEach(dispositif => {
                        const dispModules = modules.filter(m => m.parentId === dispositif.id);
                        
                        if (App.state.searchTerm && dispModules.length === 0 && 
                            !dispositif.name.toLowerCase().includes(App.state.searchTerm) && 
                            !(dispositif.objectif && dispositif.objectif.toLowerCase().includes(App.state.searchTerm))) {
                            return;
                        }
                        
                        const name = App.utils.escapeHtml(dispositif.name);
                        const objectif = dispositif.objectif ? App.utils.escapeHtml(dispositif.objectif) : '';
                        
                        html.push(`
                            <div class="tree-node" draggable="false" data-type="dispositif" data-id="${dispositif.id}"
                                 style="border-left-color: #667eea; background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                            <div style="font-weight: 700; color: #667eea; font-size: 13px;">üìÅ ${name}</div>
                                            <div class="module-actions">
                                                <button class="icon-btn" data-action="edit-dispositif" data-id="${dispositif.id}">‚úèÔ∏è</button>
                                                <button class="icon-btn" data-action="delete-dispositif" data-id="${dispositif.id}">üóëÔ∏è</button>
                                            </div>
                                        </div>
                                        ${objectif ? `<div style="font-size: 11px; color: #6c757d; margin-bottom: 5px; font-style: italic;">${objectif}</div>` : ''}
                                        <div style="font-size: 10px; color: #667eea; font-weight: 600;">
                                            ${dispModules.length} module${dispModules.length > 1 ? 's' : ''}
                                        </div>
                                    </div>
                                </div>
                                ${dispModules.map(m => App.render.moduleNode(m)).join('')}
                            </div>
                        `);
                    });
                    
                    const orphans = modules.filter(m => !m.parentId);
                    if (orphans.length > 0) {
                        html.push(`
                            <div style="margin-top: 12px; padding: 10px; background: #fff3cd; border-radius: 6px; border-left: 3px solid #ffc107;">
                                <div style="font-weight: 600; color: #856404; margin-bottom: 6px; font-size: 12px;">‚ö†Ô∏è Modules sans dispositif</div>
                                ${orphans.map(m => App.render.moduleNode(m, true)).join('')}
                            </div>
                        `);
                    }
                    
                    treeView.innerHTML = html.join('');
                },
                
                moduleNode(module, isOrphan = false) {
                    const name = App.utils.escapeHtml(module.name);
                    const niveau = module.niveauDeplacement ? `<span class="badge">${App.utils.escapeHtml(module.niveauDeplacement)}</span>` : '';
                    const borderColor = isOrphan ? '#ffc107' : '#a78bfa';
                    
                    return `
                        <div class="tree-node child" draggable="true" data-type="module" data-id="${module.id}"
                             style="margin-top: 6px; border-left-color: ${borderColor};">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                        <div style="font-weight: 600; font-size: 12px;">üìö ${name}</div>
                                        <div class="module-actions">
                                            <button class="icon-btn" data-action="duplicate-module" data-id="${module.id}">üìã</button>
                                            <button class="icon-btn" data-action="edit-module" data-id="${module.id}">‚úèÔ∏è</button>
                                            <button class="icon-btn" data-action="delete-module" data-id="${module.id}">üóëÔ∏è</button>
                                        </div>
                                    </div>
                                    <div style="font-size: 10px; color: #6c757d; margin-bottom: 3px;">
                                        üë• ${module.effectif} ‚Ä¢ ‚è±Ô∏è ${module.duree}h ‚Ä¢ üë®‚Äçüë©‚Äçüëß‚Äçüë¶ ${module.groupes} ‚Ä¢ üöó ${module.deplacements}
                                    </div>
                                    ${niveau ? `<div style="margin-top: 3px;">${niveau}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                },
                
                update() {
                    App.render.tree();
                    App.render.stats();
                }
            },
            
            actions: {
                openDispositifModal(id = null) {
                    const modal = document.getElementById('dispositifModal');
                    const form = document.getElementById('dispositifForm');
                    const title = document.getElementById('dispositifModalTitle');
                    
                    form.reset();
                    App.state.currentEditingDispositifId = id;
                    
                    if (id) {
                        title.textContent = 'Modifier le dispositif';
                        const dispositif = App.state.dispositifs.find(d => d.id === id);
                        if (dispositif) {
                            document.getElementById('dispositifName').value = dispositif.name;
                            document.getElementById('dispositifObjectif').value = dispositif.objectif || '';
                        }
                    } else {
                        title.textContent = 'Nouveau Dispositif';
                    }
                    
                    modal.classList.add('active');
                },
                
                closeDispositifModal() {
                    document.getElementById('dispositifModal').classList.remove('active');
                    App.state.currentEditingDispositifId = null;
                },
                
                async saveDispositif(e) {
                    e.preventDefault();
                    
                    const data = {
                        id: App.state.currentEditingDispositifId || 'disp-' + Date.now(),
                        name: document.getElementById('dispositifName').value,
                        objectif: document.getElementById('dispositifObjectif').value,
                        type: 'dispositif',
                        createdAt: App.state.currentEditingDispositifId 
                            ? App.state.dispositifs.find(d => d.id === App.state.currentEditingDispositifId).createdAt 
                            : new Date().toISOString()
                    };
                    
                    if (App.state.currentEditingDispositifId) {
                        const index = App.state.dispositifs.findIndex(d => d.id === App.state.currentEditingDispositifId);
                        App.state.dispositifs[index] = data;
                    } else {
                        App.state.dispositifs.push(data);
                    }
                    
                    await App.grist.save();
                    App.render.update();
                    App.actions.closeDispositifModal();
                },
                
                async deleteDispositif(id) {
                    if (confirm('Supprimer ce dispositif et tous ses modules ?')) {
                        App.state.modules = App.state.modules.filter(m => m.parentId !== id);
                        App.state.dispositifs = App.state.dispositifs.filter(d => d.id !== id);
                        await App.grist.save();
                        App.render.update();
                    }
                },
                
                openModuleModal(id = null) {
                    const modal = document.getElementById('moduleModal');
                    const form = document.getElementById('moduleForm');
                    const title = document.getElementById('modalTitle');
                    
                    form.reset();
                    App.state.currentEditingId = id;
                    
                    const parentSelect = document.getElementById('moduleParent');
                    parentSelect.innerHTML = '<option value="">Aucun</option>';
                    App.state.dispositifs.forEach(d => {
                        parentSelect.innerHTML += `<option value="${d.id}">${App.utils.escapeHtml(d.name)}</option>`;
                    });
                    
                    if (id) {
                        title.textContent = 'Modifier le module';
                        const module = App.state.modules.find(m => m.id === id);
                        if (module) {
                            document.getElementById('moduleName').value = module.name;
                            document.getElementById('moduleEffectif').value = module.effectif || '';
                            document.getElementById('moduleDuree').value = module.duree || '';
                            document.getElementById('moduleGroupes').value = module.groupes || '';
                            document.getElementById('moduleDeplacements').value = module.deplacements || '';
                            document.getElementById('moduleNiveauDeplacement').value = module.niveauDeplacement || '';
                            document.getElementById('moduleParent').value = module.parentId || '';
                            document.getElementById('moduleDescription').value = module.description || '';
                        }
                    } else {
                        title.textContent = 'Nouveau Module';
                    }
                    
                    modal.classList.add('active');
                },
                
                closeModuleModal() {
                    document.getElementById('moduleModal').classList.remove('active');
                    App.state.currentEditingId = null;
                },
                
                async saveModule(e) {
                    e.preventDefault();
                    
                    const data = {
                        id: App.state.currentEditingId || 'mod-' + Date.now(),
                        name: document.getElementById('moduleName').value,
                        type: 'module',
                        effectif: parseInt(document.getElementById('moduleEffectif').value) || 0,
                        duree: parseFloat(document.getElementById('moduleDuree').value) || 0,
                        groupes: parseInt(document.getElementById('moduleGroupes').value) || 0,
                        deplacements: parseInt(document.getElementById('moduleDeplacements').value) || 0,
                        niveauDeplacement: document.getElementById('moduleNiveauDeplacement').value || '',
                        parentId: document.getElementById('moduleParent').value || null,
                        description: document.getElementById('moduleDescription').value,
                        createdAt: App.state.currentEditingId 
                            ? App.state.modules.find(m => m.id === App.state.currentEditingId).createdAt 
                            : new Date().toISOString()
                    };
                    
                    if (App.state.currentEditingId) {
                        const index = App.state.modules.findIndex(m => m.id === App.state.currentEditingId);
                        App.state.modules[index] = data;
                    } else {
                        App.state.modules.push(data);
                    }
                    
                    await App.grist.save();
                    App.render.update();
                    App.actions.closeModuleModal();
                },
                
                async deleteModule(id) {
                    if (confirm('Supprimer ce module ?')) {
                        App.state.modules = App.state.modules.filter(m => m.id !== id);
                        await App.grist.save();
                        App.render.update();
                    }
                },
                
                async duplicateModule(id) {
                    const module = App.state.modules.find(m => m.id === id);
                    if (module) {
                        const newModule = {
                            ...module,
                            id: 'mod-' + Date.now(),
                            name: module.name + ' (copie)',
                            createdAt: new Date().toISOString()
                        };
                        App.state.modules.push(newModule);
                        await App.grist.save();
                        App.render.update();
                    }
                },
                
                exportJSON() {
                    const data = {
                        dispositifs: App.state.dispositifs,
                        modules: App.state.modules,
                        exportDate: new Date().toISOString()
                    };
                    App.utils.downloadFile(JSON.stringify(data, null, 2), 
                        `formation-${new Date().toISOString().split('T')[0]}.json`, 
                        'application/json');
                    App.actions.closeExportMenu();
                },
                
                exportExcel() {
                    let csv = 'Type,Nom,Parent,Objectif,Effectif,Dur√©e,Groupes,D√©placements,Niveau,Description\n';
                    App.state.dispositifs.forEach(d => {
                        csv += `"Dispositif","${d.name}","","${d.objectif || ''}","","","","","",""\n`;
                    });
                    App.state.modules.forEach(m => {
                        const parent = App.state.dispositifs.find(d => d.id === m.parentId);
                        csv += `"Module","${m.name}","${parent ? parent.name : ''}","","${m.effectif}","${m.duree}","${m.groupes}","${m.deplacements}","${m.niveauDeplacement || ''}","${m.description || ''}"\n`;
                    });
                    App.utils.downloadFile('\uFEFF' + csv, 
                        `formation-${new Date().toISOString().split('T')[0]}.csv`, 
                        'text/csv;charset=utf-8;');
                    App.actions.closeExportMenu();
                },
                
                async syncData() {
                    await App.grist.load();
                },
                
                toggleExportMenu(e) {
                    e.stopPropagation();
                    document.getElementById('exportDropdown').classList.toggle('active');
                },
                
                closeExportMenu() {
                    document.getElementById('exportDropdown').classList.remove('active');
                }
            },
            
            dragDrop: {
                init() {
                    const treeView = document.getElementById('treeView');
                    
                    treeView.addEventListener('dragstart', (e) => {
                        const el = e.target.closest('[data-type]');
                        if (!el) return;
                        App.state.draggedElement = { type: el.dataset.type, id: el.dataset.id };
                        el.classList.add('dragging');
                    });
                    
                    treeView.addEventListener('dragover', (e) => {
                        if (!App.state.draggedElement) return;
                        e.preventDefault();
                        const target = e.target.closest('[data-type]');
                        if (!target || App.state.draggedElement.type !== 'module') return;
                        if (target.dataset.id === App.state.draggedElement.id) return;
                        if (target.dataset.type === 'dispositif' || target.dataset.type === 'module') {
                            target.classList.add('drag-over');
                        }
                    });
                    
                    treeView.addEventListener('dragleave', (e) => {
                        const target = e.target.closest('[data-type]');
                        if (target) target.classList.remove('drag-over');
                    });
                    
                    treeView.addEventListener('drop', async (e) => {
                        e.preventDefault();
                        const target = e.target.closest('[data-type]');
                        if (!target || !App.state.draggedElement || App.state.draggedElement.type !== 'module') return;
                        if (target.dataset.id === App.state.draggedElement.id) return;
                        
                        const module = App.state.modules.find(m => m.id === App.state.draggedElement.id);
                        if (!module) return;
                        
                        if (target.dataset.type === 'dispositif') {
                            module.parentId = target.dataset.id;
                        } else if (target.dataset.type === 'module') {
                            const targetModule = App.state.modules.find(m => m.id === target.dataset.id);
                            if (targetModule) module.parentId = targetModule.parentId;
                        }
                        
                        await App.grist.save();
                        App.render.update();
                        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                    });
                    
                    treeView.addEventListener('dragend', (e) => {
                        const el = e.target.closest('[data-type]');
                        if (el) el.classList.remove('dragging');
                        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                        App.state.draggedElement = null;
                    });
                }
            },
            
            async init() {
                await App.grist.init();
                
                document.addEventListener('click', (e) => {
                    const action = e.target.closest('[data-action]');
                    if (!action) return;
                    
                    e.stopPropagation();
                    const actionType = action.dataset.action;
                    const id = action.dataset.id;
                    
                    switch(actionType) {
                        case 'open-dispositif-modal': App.actions.openDispositifModal(); break;
                        case 'open-module-modal': App.actions.openModuleModal(); break;
                        case 'close-dispositif-modal': App.actions.closeDispositifModal(); break;
                        case 'close-module-modal': App.actions.closeModuleModal(); break;
                        case 'edit-dispositif': App.actions.openDispositifModal(id); break;
                        case 'delete-dispositif': App.actions.deleteDispositif(id); break;
                        case 'edit-module': App.actions.openModuleModal(id); break;
                        case 'delete-module': App.actions.deleteModule(id); break;
                        case 'duplicate-module': App.actions.duplicateModule(id); break;
                        case 'toggle-export': App.actions.toggleExportMenu(e); break;
                        case 'export-json': App.actions.exportJSON(); break;
                        case 'export-excel': App.actions.exportExcel(); break;
                        case 'sync-data': App.actions.syncData(); break;
                    }
                });
                
                document.addEventListener('click', (e) => {
                    const dropdown = document.getElementById('exportDropdown');
                    if (!dropdown.contains(e.target)) dropdown.classList.remove('active');
                });
                
                document.getElementById('moduleModal').addEventListener('click', (e) => {
                    if (e.target.id === 'moduleModal') App.actions.closeModuleModal();
                });
                
                document.getElementById('dispositifModal').addEventListener('click', (e) => {
                    if (e.target.id === 'dispositifModal') App.actions.closeDispositifModal();
                });
                
                const debouncedSearch = App.utils.debounce(() => {
                    App.state.searchTerm = document.getElementById('searchInput').value.toLowerCase();
                    App.render.tree();
                }, 300);
                
                document.getElementById('searchInput').addEventListener('input', debouncedSearch);
                document.getElementById('dispositifForm').addEventListener('submit', App.actions.saveDispositif);
                document.getElementById('moduleForm').addEventListener('submit', App.actions.saveModule);
                
                App.dragDrop.init();
            }
        };
        
        App.init();
    </script>
</body>
</html>
